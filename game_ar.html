<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ø®Ù…Ø³Ø© (5amsa)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Changed font to Cairo for better Arabic rendering */
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap');

        body {
            font-family: 'Cairo', sans-serif;
            user-select: none;
            -webkit-user-select: none;
        }

        /* Card Styles */
        .card-shadow {
            box-shadow: 0 4px 0 0 rgba(0, 0, 0, 0.1);
        }

        .card-interactive:active {
            transform: translateY(4px);
            box-shadow: none;
        }

        .card-selected {
            transform: translateY(-8px) !important;
            box-shadow: 0 0 0 4px #292524, 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        /* Utility */
        .hidden {
            display: none !important;
        }

        .transition-width {
            transition-property: width;
        }
    </style>
</head>

<body class="bg-[#F5F5DC] text-stone-800 h-screen w-full overflow-hidden flex flex-col">

    <div id="app" class="relative w-full h-full flex flex-col">

        <div id="screen-start"
            class="absolute inset-0 z-50 flex items-center justify-center bg-stone-100/90 backdrop-blur-sm transition-opacity duration-300">
            <div class="text-center space-y-6 max-w-md px-6">
                <h1 class="text-7xl font-black text-stone-800 tracking-tighter">Ø®Ù…Ø³Ø©</h1>
                <p class="text-stone-600 text-lg leading-relaxed">
                    Ø§Ø¬Ù…Ø¹ 5 Ø¨Ø·Ø§Ù‚Ø§Øª Ù…Ù† Ù†ÙØ³ Ø§Ù„Ø­Ø±Ù Ù„ØªØ±Ø¨Ø­ <span class="text-amber-500 font-bold">ÙÙˆØ±Ø§Ù‹</span>.
                    <br />
                    Ø¨Ø§Ø¯Ù„ Ø¨Ø³Ø±Ø¹Ø©! Ù„Ø¯ÙŠÙƒ <span class="font-bold text-rose-500">5 Ø«ÙˆØ§Ù†Ù</span> ÙÙ‚Ø· Ù„ÙƒÙ„ Ø¬ÙˆÙ„Ø©.
                </p>
                <button onclick="startGame()"
                    class="group relative inline-flex items-center gap-3 px-8 py-4 bg-stone-800 text-white rounded-2xl font-bold text-xl shadow-xl hover:scale-105 transition-all active:scale-95 cursor-pointer">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="rotate-180">
                        <polygon points="5 3 19 12 5 21 5 3"></polygon>
                    </svg>
                    Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨
                </button>
                <div class="pt-8">
                    <span class="text-xs font-bold text-stone-400 uppercase tracking-widest"></span>
                </div>
            </div>
        </div>

        <div id="screen-game" class="flex-1 flex flex-col max-w-5xl mx-auto w-full h-full p-2 sm:p-4 hidden">

            <div class="flex gap-2 justify-center py-2 sm:py-4 min-h-[120px] sm:min-h-[140px] relative">
                <div id="bot-hand-container" class="flex -space-x-3 sm:space-x-2">
                    </div>
                <div class="absolute top-2 right-2 flex flex-col items-end">
                    <span
                        class="text-[10px] sm:text-sm font-bold text-stone-500 uppercase tracking-widest bg-stone-200 px-3 py-1 rounded-full">
                        Ø§Ù„Ø®ØµÙ…
                    </span>
                </div>
            </div>

            <div class="flex-1 relative flex flex-col justify-center">

                <div
                    class="absolute top-0 left-0 right-0 h-4 bg-stone-200 rounded-full overflow-hidden mx-4 sm:mx-12 shadow-inner border border-stone-300/50">
                    <div id="timer-bar" class="h-full bg-stone-800 transition-width duration-100 ease-linear"
                        style="width: 100%;"></div>
                </div>
                <div id="timer-text"
                    class="absolute top-6 left-1/2 -translate-x-1/2 font-bold text-stone-400 text-xs tracking-widest uppercase">
                    5.0 Ø«ÙˆØ§Ù†ÙŠ
                </div>

                <div class="flex-1 flex flex-col items-center justify-center gap-8 py-4 w-full">

                    <div
                        class="absolute right-2 sm:right-4 top-1/2 -translate-y-1/2 flex flex-col items-center gap-2 opacity-60">
                        <div
                            class="w-12 h-16 sm:w-16 sm:h-24 bg-stone-800 rounded-xl border-4 border-white shadow-xl flex items-center justify-center">
                            <span id="deck-count" class="text-white font-bold text-lg sm:text-xl">0</span>
                        </div>
                        <span class="text-[10px] sm:text-xs font-bold text-stone-400">Ø§Ù„ÙˆØ±Ù‚</span>
                    </div>

                    <div
                        class="absolute left-2 sm:left-4 top-1/2 -translate-y-1/2 flex flex-col items-center gap-2 opacity-60">
                        <div
                            class="w-12 h-16 sm:w-16 sm:h-24 bg-stone-200/50 rounded-xl border-2 border-dashed border-stone-300 flex items-center justify-center">
                            <span class="text-xl sm:text-2xl text-stone-300">â™»</span>
                        </div>
                        <span class="text-[10px] sm:text-xs font-bold text-stone-400">Ø§Ù„Ù…Ù‡Ù…Ù„Ø§Øª</span>
                    </div>

                    <div class="relative w-full flex flex-col items-center">
                        <h3 class="text-center text-stone-400 font-bold uppercase tracking-widest text-xs mb-2 sm:mb-4">
                            Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ØªØ¨Ø§Ø¯Ù„</h3>
                        <div id="ground-container" class="flex gap-2 sm:gap-4 justify-center items-center">
                            </div>
                    </div>
                </div>

                <div class="absolute bottom-2 left-2 sm:bottom-4 sm:left-4 hidden sm:block">
                    <div
                        class="bg-white/80 px-4 py-2 rounded-xl shadow-sm text-sm font-bold text-stone-500 border border-stone-100">
                        Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©: <span id="hand-rank" class="text-stone-800">ÙˆØ±Ù‚Ø© Ø¹Ù„ÙŠØ§</span>
                    </div>
                </div>
            </div>

            <div class="relative">
                <div
                    class="flex gap-2 justify-center py-4 bg-white/50 backdrop-blur-sm border-t border-stone-200 rounded-t-3xl shadow-2xl relative z-10 min-h-[140px] sm:min-h-[160px]">
                    <div id="player-hand-container"
                        class="flex -space-x-3 sm:space-x-4 px-4 overflow-x-auto pb-2 sm:pb-0 scrollbar-hide">
                        </div>
                    <div class="absolute top-[-14px] left-1/2 -translate-x-1/2 pointer-events-none">
                        <span
                            class="text-xs sm:text-sm font-bold text-white bg-stone-800 px-4 py-1 rounded-full shadow-lg">
                            Ø£ÙˆØ±Ø§Ù‚Ùƒ
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <div id="screen-gameover"
            class="hidden absolute inset-0 z-50 bg-stone-900/40 backdrop-blur-md flex items-center justify-center p-4">
            <div
                class="bg-white rounded-3xl p-8 max-w-lg w-full shadow-2xl text-center space-y-6 sm:space-y-8 animate-in fade-in zoom-in duration-300">
                <div>
                    <h2 class="text-3xl font-black text-stone-800 mb-2">Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©!</h2>
                    <p id="game-over-reason" class="text-stone-500">Ù†ÙØ¯ Ø§Ù„ÙˆØ±Ù‚ Ù…Ù† Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©.</p>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div id="result-player"
                        class="p-4 sm:p-6 rounded-2xl flex flex-col items-center gap-2 border-2 bg-white border-stone-200">
                        <h3 class="text-lg sm:text-xl font-bold text-stone-700">Ø£Ù†Øª</h3>
                        <div class="score-val text-4xl sm:text-5xl font-black text-stone-800">0</div>
                        <div
                            class="score-desc text-xs sm:text-sm font-medium text-stone-500 uppercase tracking-wider text-center">
                            -</div>
                        <div class="winner-badge hidden mt-2 text-amber-500 font-bold text-sm">Ø§Ù„ÙØ§Ø¦Ø²! ğŸ‘‘</div>
                    </div>
                    <div id="result-bot"
                        class="p-4 sm:p-6 rounded-2xl flex flex-col items-center gap-2 border-2 bg-white border-stone-200">
                        <h3 class="text-lg sm:text-xl font-bold text-stone-700">Ø§Ù„Ø¨ÙˆØª</h3>
                        <div class="score-val text-4xl sm:text-5xl font-black text-stone-800">0</div>
                        <div
                            class="score-desc text-xs sm:text-sm font-medium text-stone-500 uppercase tracking-wider text-center">
                            -</div>
                        <div class="winner-badge hidden mt-2 text-amber-500 font-bold text-sm">Ø§Ù„ÙØ§Ø¦Ø²! ğŸ‘‘</div>
                    </div>
                </div>

                <button onclick="startGame()"
                    class="w-full py-4 bg-stone-800 hover:bg-stone-700 text-white rounded-xl font-bold text-lg transition-transform active:scale-95 shadow-xl cursor-pointer">
                    Ø§Ù„Ø¹Ø¨ Ù…Ø¬Ø¯Ø¯Ø§Ù‹
                </button>
            </div>
        </div>

    </div>

    <script>
        // --- CONSTANTS & CONFIG ---
        const CONFIG = {
            ROUND_MS: 10000,
            HAND_SIZE: 5,
            GROUND_SIZE: 5,
            CATEGORIES: [
                { type: 'Ø¥Ø³Ù…', color: 'bg-sky-200' },     // Name
                { type: 'Ø­ÙŠÙˆØ§Ù†', color: 'bg-orange-200' }, // Animal
                { type: 'Ù†Ø¨Ø§Øª', color: 'bg-emerald-200' }, // Plant
                { type: 'Ø¬Ù…Ø§Ø¯', color: 'bg-purple-200' },  // Object
                { type: 'Ø¨Ù„Ø§Ø¯', color: 'bg-rose-200' }     // Country
            ],
            LETTERS: {
                Ø£: ['Ø£Ø­Ù…Ø¯', 'Ø£Ø³Ø¯', 'Ø£Ø±Ø²', 'Ø¥Ø¨Ø±ÙŠÙ‚', 'Ø£Ù…Ø±ÙŠÙƒØ§'],
                Ø¨: ['Ø¨Ø§Ø³Ù…', 'Ø¨Ø·Ø©', 'Ø¨ØµÙ„', 'Ø¨Ø§Ø¨', 'Ø¨Ø±Ø§Ø²ÙŠÙ„'],
                Øª: ['ØªØ§Ù…Ø±', 'ØªÙ…Ø³Ø§Ø­', 'ØªÙØ§Ø­', 'ØªØ§Ø¬', 'ØªÙˆÙ†Ø³'],
                Ø«: ['Ø«Ø§Ù…Ø±', 'Ø«Ø¹Ù„Ø¨', 'Ø«ÙˆÙ…', 'Ø«Ù„Ø§Ø¬Ø©', 'Ø«ÙŠØ¨Ø³'],
                Ø¬: ['Ø¬Ù…ÙŠÙ„', 'Ø¬Ù…Ù„', 'Ø¬Ø²Ø±', 'Ø¬Ø±Ø³', 'Ø¬Ø§Ù…ÙŠÙƒØ§'],
                Ø­: ['Ø­Ø³Ù†', 'Ø­ØµØ§Ù†', 'Ø­Ù…Øµ', 'Ø­Ù‚ÙŠØ¨Ø©', 'Ø­Ù„Ø¨'],
                Ø®: ['Ø®Ø§Ù„Ø¯', 'Ø®Ø±ÙˆÙ', 'Ø®Ø³', 'Ø®Ø§ØªÙ…', 'Ø®Ø±Ø·ÙˆÙ…'],
                Ø¯: ['Ø¯Ù„Ø§Ù„', 'Ø¯Ø¨', 'Ø¯Ø±Ø§Ù‚', 'Ø¯ÙØªØ±', 'Ø¯Ù†Ù…Ø§Ø±Ùƒ'],
                Ø°: ['Ø°ÙƒØ±Ù‰', 'Ø°Ø¦Ø¨', 'Ø°Ø±Ø©', 'Ø°Ù‡Ø¨', 'Ø°ÙŠ Ù‚Ø§Ø±'],
                Ø±: ['Ø±Ø§Ù…ÙŠ', 'Ø±Ø§ÙƒÙˆÙ†', 'Ø±Ù…Ø§Ù†', 'Ø±Ù…Ø­', 'Ø±ÙˆØ³ÙŠØ§'],
                Ø²: ['Ø²ÙŠØ§Ø¯', 'Ø²Ø±Ø§ÙØ©', 'Ø²ÙŠØªÙˆÙ†', 'Ø²Ø±', 'Ø²Ø§Ù…Ø¨ÙŠØ§'],
                Ø³: ['Ø³Ø§Ø±Ø©', 'Ø³Ù„Ø­ÙØ§Ø©', 'Ø³Ø¨Ø§Ù†Ø®', 'Ø³Ø§Ø¹Ø©', 'Ø³ÙˆØ±ÙŠØ§'],
                Ø´: ['Ø´Ø§Ø¯ÙŠ', 'Ø´Ù…Ø¨Ø§Ù†Ø²ÙŠ', 'Ø´Ù…Ø§Ù…', 'Ø´Ù…Ø¹Ø©', 'Ø´ÙŠÙ„ÙŠ'],
                Øµ: ['ØµØ§Ø¨Ø±', 'ØµÙ‚Ø±', 'ØµØ¨Ø§Ø±', 'ØµØ§Ø±ÙˆØ®', 'ØµÙˆÙ…Ø§Ù„'],
                Ø¶: ['Ø¶Ø­Ù‰', 'Ø¶Ø¨Ø¹', 'Ø¶Ø±Ù…', 'Ø¶ÙˆØ¡', 'Ø¶ÙØ©'],
                Ø·: ['Ø·Ø§Ø±Ù‚', 'Ø·Ø§ÙˆÙˆØ³', 'Ø·Ù…Ø§Ø·Ù…', 'Ø·Ø§ÙˆÙ„Ø©', 'Ø·ÙˆÙƒÙŠÙˆ'],
                Ø¸: ['Ø¸Ø§ÙØ±', 'Ø¸Ø¨ÙŠ', 'Ø¸ÙŠØ§Ù†', 'Ø¸Ø±Ù', 'Ø¸Ù‡Ø±Ø§Ù†'],
                Ø¹: ['Ø¹Ù„ÙŠ', 'Ø¹Ù†ÙƒØ¨ÙˆØª', 'Ø¹Ù†Ø¨', 'Ø¹Ù„Ù…', 'Ø¹Ù…Ø§Ù†'],
                Øº: ['ØºØ§Ø¯Ø©', 'ØºØ²Ø§Ù„', 'ØºØ§Ø±', 'ØºØ³Ø§Ù„Ø©', 'ØºØ§Ù†Ø§'],
                Ù: ['ÙØ§Ø¯ÙŠ', 'ÙÙŠÙ„', 'ÙØ±Ø§ÙˆÙ„Ø©', 'ÙØ£Ø³', 'ÙØ±Ù†Ø³Ø§'],
                Ù‚: ['Ù‚Ø§Ø³Ù…', 'Ù‚Ø±Ø¯', 'Ù‚Ù…Ø­', 'Ù‚Ù„Ù…', 'Ù‚Ø·Ø±'],
                Ùƒ: ['ÙƒÙ…Ø§Ù„', 'ÙƒÙ„Ø¨', 'ÙƒØ±Ø²', 'ÙƒØ±Ø³ÙŠ', 'ÙƒÙ†Ø¯Ø§'],
                Ù„: ['Ù„Ù…Ù‰', 'Ù„ÙŠØ«', 'Ù„ÙŠÙ…ÙˆÙ†', 'Ù„ÙˆØ­Ø©', 'Ù„Ø¨Ù†Ø§Ù†'],
                Ù…: ['Ù…Ø­Ù…Ø¯', 'Ù…Ø§Ø¹Ø²', 'Ù…ÙˆØ²', 'Ù…ÙØªØ§Ø­', 'Ù…ØµØ±'],
                Ù†: ['Ù†Ø§Ø¯Ø±', 'Ù†Ù…Ø±', 'Ù†Ø¹Ù†Ø§Ø¹', 'Ù†Ø¸Ø§Ø±Ø©', 'Ù†Ø±ÙˆÙŠØ¬'],
                Ù‡Ù€: ['Ù‡Ø§Ù†ÙŠ', 'Ù‡Ø±Ø©', 'Ù‡ÙŠÙ„', 'Ù‡Ø§ØªÙ', 'Ù‡ÙˆÙ„Ù†Ø¯Ø§'],
                Ùˆ: ['ÙˆÙ„ÙŠØ¯', 'ÙˆØ·ÙˆØ§Ø·', 'ÙˆØ±Ø¯', 'ÙˆØ³Ø§Ø¯Ø©', 'ÙˆØ§Ø´Ù†Ø·Ù†'],
                ÙŠ: ['ÙŠØ§Ø³Ø±', 'ÙŠØ¹Ø³ÙˆØ¨', 'ÙŠØ§Ø³Ù…ÙŠÙ†', 'ÙŠØ®Øª', 'ÙŠØ§Ø¨Ø§Ù†'],
            }
        };

        // --- GLOBAL STATE ---
        let state = {
            status: 'IDLE', // IDLE, PLAYING, ROUND_END, GAME_OVER
            deck: [],
            ground: [],
            playerHand: [],
            botHand: [],
            selectedId: null,
            timeLeft: 0,
            intervals: { timer: null, bot: null }
        };

        // --- AUDIO SYSTEM ---
        const AudioCtx = window.AudioContext || window.webkitAudioContext;
        const ctx = AudioCtx ? new AudioCtx() : null;

        function playSound(type) {
            if (!ctx) return;
            if (ctx.state === 'suspended') ctx.resume();

            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            const now = ctx.currentTime;

            osc.connect(gain);
            gain.connect(ctx.destination);

            switch (type) {
                case 'deal':
                    osc.frequency.setValueAtTime(300, now);
                    osc.frequency.exponentialRampToValueAtTime(50, now + 0.1);
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.linearRampToValueAtTime(0, now + 0.1);
                    osc.start(now); osc.stop(now + 0.1);
                    break;
                case 'swap':
                    osc.frequency.setValueAtTime(600, now);
                    gain.gain.setValueAtTime(0.05, now);
                    gain.gain.linearRampToValueAtTime(0, now + 0.05);
                    osc.start(now); osc.stop(now + 0.05);
                    break;
                case 'tick':
                    osc.type = 'square';
                    osc.frequency.setValueAtTime(800, now);
                    gain.gain.setValueAtTime(0.02, now);
                    gain.gain.linearRampToValueAtTime(0, now + 0.03);
                    osc.start(now); osc.stop(now + 0.03);
                    break;
                case 'win':
                    osc.type = 'triangle';
                    [440, 554, 659, 880].forEach((freq, i) => {
                        osc.frequency.setValueAtTime(freq, now + i * 0.1);
                    });
                    gain.gain.setValueAtTime(0.2, now);
                    gain.gain.exponentialRampToValueAtTime(0.001, now + 1);
                    osc.start(now); osc.stop(now + 1);
                    break;
                case 'lose':
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(200, now);
                    osc.frequency.linearRampToValueAtTime(50, now + 0.5);
                    gain.gain.setValueAtTime(0.2, now);
                    gain.gain.linearRampToValueAtTime(0, now + 0.5);
                    osc.start(now); osc.stop(now + 0.5);
                    break;
            }
        }

        // --- LOGIC HELPER FUNCTIONS ---
        function generateDeck() {
            let deck = [];
            Object.entries(CONFIG.LETTERS).forEach(([letter, words]) => {
                words.forEach((word, idx) => {
                    deck.push({
                        id: Math.random().toString(36).substr(2, 9),
                        letter, word,
                        category: CONFIG.CATEGORIES[idx].type,
                        color: CONFIG.CATEGORIES[idx].color
                    });
                });
            });
            // Fisher-Yates Shuffle
            for (let i = deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [deck[i], deck[j]] = [deck[j], deck[i]];
            }
            return deck;
        }

        function calculateScore(hand) {
            const counts = {};
            hand.forEach(c => counts[c.letter] = (counts[c.letter] || 0) + 1);
            const freqs = Object.values(counts).sort((a, b) => b - a);
            const max = freqs[0] || 0;

            if (max === 5) return { pts: 10, desc: "Ø®Ù…Ø³Ø© (Ø·Ù‚Ù… ÙƒØ§Ù…Ù„)" }; // Perfect Set
            if (max === 4) return { pts: 8, desc: "Ø£Ø±Ø¨Ø¹Ø© Ù…ØªØ´Ø§Ø¨Ù‡Ø©" }; // Four of a kind
            if (freqs[0] === 3 && freqs[1] === 2) return { pts: 6, desc: "Ø«Ù„Ø§Ø«Ø© ÙˆØ§Ø«Ù†Ø§Ù†" }; // Full House
            if (max === 3) return { pts: 4, desc: "Ø«Ù„Ø§Ø«Ø© Ù…ØªØ´Ø§Ø¨Ù‡Ø©" }; // Three of a kind
            if (max === 2) return { pts: 2, desc: "Ø²ÙˆØ¬" }; // Pair
            return { pts: 0, desc: "ÙˆØ±Ù‚Ø© Ø¹Ù„ÙŠØ§" }; // High Card
        }

        // --- CORE GAME ACTIONS ---
        function startGame() {
            // Reset State
            state.deck = generateDeck();
            state.playerHand = state.deck.splice(0, CONFIG.HAND_SIZE);
            state.botHand = state.deck.splice(0, CONFIG.HAND_SIZE);
            state.ground = state.deck.splice(0, CONFIG.GROUND_SIZE);
            state.status = 'PLAYING';
            state.timeLeft = CONFIG.ROUND_MS;
            state.selectedId = null;

            // UI Transitions
            document.getElementById('screen-start').classList.add('hidden');
            document.getElementById('screen-gameover').classList.add('hidden');
            document.getElementById('screen-game').classList.remove('hidden');

            // Start Loops
            clearInterval(state.intervals.timer);
            clearInterval(state.intervals.bot);

            state.intervals.timer = setInterval(gameLoop, 100);
            state.intervals.bot = setInterval(botTurn, 1500);

            playSound('deal');
            render();
        }

        function gameLoop() {
            if (state.status !== 'PLAYING') return;

            state.timeLeft -= 100;
            if (state.timeLeft <= 0) {
                endRound();
            }
            renderTimer();
        }

        function endRound() {
            state.status = 'ROUND_END';
            playSound('tick');
            render(); // updates status

            setTimeout(() => {
                // Move ground to trash (simulated by just dropping ref)
                if (state.deck.length < CONFIG.GROUND_SIZE) {
                    gameOver("deck");
                    return;
                }

                // Deal new ground
                state.ground = state.deck.splice(0, CONFIG.GROUND_SIZE);
                state.timeLeft = CONFIG.ROUND_MS;
                state.status = 'PLAYING';
                playSound('deal');
                render();
            }, 600);
        }

        function botTurn() {
            if (state.status !== 'PLAYING') return;

            // Check win
            if (calculateScore(state.botHand).pts === 10) {
                gameOver("bot");
                return;
            }

            // Simple Logic: Identify target letter (most frequent)
            const counts = {};
            state.botHand.forEach(c => counts[c.letter] = (counts[c.letter] || 0) + 1);
            const target = Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b);

            const junkIdx = state.botHand.findIndex(c => c.letter !== target);
            if (junkIdx === -1) return; // Hand full of target? Should have won.

            // Look for target in ground
            const groundIdx = state.ground.findIndex(c => c.letter === target);

            if (groundIdx !== -1) {
                swapCards(state.botHand, junkIdx, groundIdx, false);
            } else if (Math.random() > 0.7) {
                // Random swap
                const rndGround = Math.floor(Math.random() * state.ground.length);
                swapCards(state.botHand, junkIdx, rndGround, false);
            }
        }

        function swapCards(hand, handIdx, groundIdx, isPlayer) {
            const cardInHand = hand[handIdx];
            const cardInGround = state.ground[groundIdx];

            hand[handIdx] = cardInGround;
            state.ground[groundIdx] = cardInHand;

            playSound('swap');

            if (isPlayer) {
                state.selectedId = null;
                render();
                if (calculateScore(state.playerHand).pts === 10) gameOver("player");
            } else {
                render(); // Re-render for bot move visualization
                if (calculateScore(state.botHand).pts === 10) gameOver("bot");
            }
        }

        function gameOver(reason) {
            state.status = 'GAME_OVER';
            clearInterval(state.intervals.timer);
            clearInterval(state.intervals.bot);

            const pScore = calculateScore(state.playerHand);
            const bScore = calculateScore(state.botHand);

            // Update UI
            const setRes = (id, name, score, winner) => {
                const el = document.getElementById(id);
                el.querySelector('.score-val').textContent = score.pts;
                el.querySelector('.score-desc').textContent = score.desc;
                el.className = `p-4 sm:p-6 rounded-2xl flex flex-col items-center gap-2 border-2 ${winner ? 'bg-amber-50 border-amber-300' : 'bg-white border-stone-200'}`;
                el.querySelector('.winner-badge').classList.toggle('hidden', !winner);
            };

            const pWins = pScore.pts > bScore.pts;
            const tie = pScore.pts === bScore.pts;

            setRes('result-player', 'You', pScore, !tie && pWins);
            setRes('result-bot', 'Bot', bScore, !tie && !pWins);

            let msg = "Ù†ÙØ¯ Ø§Ù„ÙˆØ±Ù‚ Ù…Ù† Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©.";
            if (reason === "player") msg = "Ø£Ù†Øª Ø¬Ù…Ø¹Øª Ø®Ù…Ø³Ø©! ÙÙˆØ² ÙÙˆØ±ÙŠ!";
            if (reason === "bot") msg = "Ø§Ù„Ø¨ÙˆØª Ø¬Ù…Ø¹ Ø®Ù…Ø³Ø©! Ø®Ø³Ø±Ù†Ø§!";
            document.getElementById('game-over-reason').textContent = msg;

            document.getElementById('screen-gameover').classList.remove('hidden');

            const isWin = (reason === 'player') || (reason === 'deck' && pWins);
            playSound(isWin ? 'win' : 'lose');
        }

        // --- INTERACTION ---
        window.handleCardClick = (id) => {
            if (state.status !== 'PLAYING') return;

            // Is it in player hand?
            const pIdx = state.playerHand.findIndex(c => c.id === id);
            if (pIdx !== -1) {
                state.selectedId = (state.selectedId === id) ? null : id;
                playSound('tick'); // faint click
                render();
                return;
            }

            // Is it in ground?
            const gIdx = state.ground.findIndex(c => c.id === id);
            if (gIdx !== -1 && state.selectedId) {
                const handIdx = state.playerHand.findIndex(c => c.id === state.selectedId);
                if (handIdx !== -1) {
                    swapCards(state.playerHand, handIdx, gIdx, true);
                }
            }
        };

        // --- RENDER ENGINE ---
        function renderCardHTML(card, isFaceDown, isSelected, interactive, sizeClass) {
            const selectClass = isSelected ? 'card-selected' : '';
            const interactClass = interactive ? 'card-interactive cursor-pointer hover:-translate-y-1' : '';
            const bgClass = isFaceDown ? 'bg-stone-300 border-stone-400' : `${card.color} border-white`;

            let content = '';
            if (isFaceDown) {
                content = `<div class="w-full h-full flex items-center justify-center opacity-20"><span class="text-3xl font-black">?</span></div>`;
            } else {
                content = `
                    <div class="flex flex-col items-center justify-center w-full h-full p-1 sm:p-2 text-center relative pointer-events-none">
                        <span class="absolute top-1 right-1.5 text-[10px] sm:text-xs font-extrabold text-stone-900/40">${card.letter}</span>
                        <div class="flex flex-col items-center justify-center flex-1 z-10">
                            <span class="font-black text-xs sm:text-lg text-stone-800 drop-shadow-sm leading-tight break-all">${card.word}</span>
                        </div>
                        <div class="mt-1 px-1.5 py-0.5 bg-white/40 rounded-full z-10">
                            <span class="text-[8px] sm:text-[10px] font-bold uppercase tracking-wider text-stone-800/70">${card.category}</span>
                        </div>
                        <span class="absolute bottom-[-5px] left-[-5px] text-4xl sm:text-5xl font-black text-white/20 select-none -rotate-12 z-0">${card.letter}</span>
                    </div>
                `;
            }

            return `
                <div class="card-shadow relative flex flex-col items-center justify-center border-2 overflow-hidden transition-transform duration-100 ease-out rounded-xl ${sizeClass} ${bgClass} ${selectClass} ${interactClass}"
                     onclick="handleCardClick('${card.id}')">
                     ${content}
                </div>
            `;
        }

        function render() {
            // Player Hand
            const pHTML = state.playerHand.map(c =>
                renderCardHTML(c, false, state.selectedId === c.id, true, 'w-20 h-28 sm:w-24 sm:h-36')
            ).join('');
            document.getElementById('player-hand-container').innerHTML = pHTML;

            // Bot Hand
            const bHTML = state.botHand.map(c =>
                `<div class="relative z-0 hover:z-10 transition-all">${renderCardHTML(c, true, false, false, 'w-16 h-24 sm:w-20 sm:h-28')}</div>`
            ).join('');
            document.getElementById('bot-hand-container').innerHTML = bHTML;

            // Ground
            const gHTML = state.ground.length ? state.ground.map(c =>
                renderCardHTML(c, false, false, true, 'w-20 h-28 sm:w-24 sm:h-36')
            ).join('') : `<div class="text-stone-400 font-bold italic w-full text-center">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ¬Ø¯ÙŠØ¯...</div>`;
            document.getElementById('ground-container').innerHTML = gHTML;

            // Meta
            document.getElementById('deck-count').textContent = state.deck.length;
            document.getElementById('hand-rank').textContent = calculateScore(state.playerHand).desc;

            // Timer bar handled separately for performance
            renderTimer();
        }

        function renderTimer() {
            const pct = Math.max(0, (state.timeLeft / CONFIG.ROUND_MS) * 100);
            const bar = document.getElementById('timer-bar');
            bar.style.width = `${pct}%`;
            bar.className = `h-full transition-width duration-100 linear ${state.timeLeft < 2000 ? 'bg-rose-500' : 'bg-stone-800'}`;
            document.getElementById('timer-text').textContent = (state.timeLeft / 1000).toFixed(1) + " Ø«ÙˆØ§Ù†ÙŠ";
        }

    </script>
</body>

</html>
